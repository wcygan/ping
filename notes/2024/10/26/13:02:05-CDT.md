# Strimzi Operator

It appears that we've been able to successfully install the Strimzi Kafka Operator.  The following is the Skaffold configuration that was used to install the operator.

```yaml
profiles:
  - name: bootstrap
    patches:
      - op: replace
        path: /requires
        value:
          ...
          - configs:
            - kafka-install
            path: kafka/skaffold.yaml
```

```yaml
apiVersion: skaffold/v4beta1
kind: Config
metadata:
  name: kafka-install
deploy:
  helm:
    releases:
      - name: strimzi
        repo: https://strimzi.io/charts/
        remoteChart: strimzi-kafka-operator
        namespace: kafka-system
        createNamespace: true
        wait: true
```

```bash
kubectl get pods --all-namespaces
NAMESPACE       NAME                                        READY   STATUS      RESTARTS      AGE
cnpg-system     cnpg-cloudnative-pg-9b446b994-m5p7b         1/1     Running     0             13h
ingress-nginx   ingress-nginx-admission-create-qqgmm        0/1     Completed   0             43d
ingress-nginx   ingress-nginx-admission-patch-blvmf         0/1     Completed   0             43d
ingress-nginx   ingress-nginx-controller-7c6974c4d8-vft9d   1/1     Running     4 (17h ago)   43d
kafka-system    strimzi-cluster-operator-cf87845f5-5p6zk    1/1     Running     0             119s
kube-system     coredns-5dd5756b68-958sz                    1/1     Running     4 (17h ago)   43d
kube-system     etcd-minikube                               1/1     Running     4 (17h ago)   43d
kube-system     kube-apiserver-minikube                     1/1     Running     4 (17h ago)   43d
kube-system     kube-controller-manager-minikube            1/1     Running     4 (17h ago)   43d
kube-system     kube-proxy-s2r2h                            1/1     Running     4 (17h ago)   43d
kube-system     kube-scheduler-minikube                     1/1     Running     4 (17h ago)   43d
kube-system     storage-provisioner                         1/1     Running     8 (17h ago)   43d
```

Or, to just check the `kafka-system` namespace:

```bash
kubectl get pods -n kafka-system
NAME                                       READY   STATUS    RESTARTS   AGE
strimzi-cluster-operator-cf87845f5-5p6zk   1/1     Running   0          3m52s
```

## Kafka Pods

Do we need ot introduce any type of ordering into the deployment? Basically, ensure that Kafka and Postgres are running before the application is deployed?

```bash
k apply -f kafka/base/kafka-cluster.yaml 
kafka.kafka.strimzi.io/ping-kafka-cluster configured
kafkanodepool.kafka.strimzi.io/ping-kafka-cluster-pool unchanged
```

How can I check the status of the Kafka cluster?

```bash
kubectl get kafkas
```

## Still no luck, let's try deploying Kafka again

This time, we're using `kafka-system` as the namespace throughout the deployment.

```bash
k apply -f kafka/base/kafka-cluster.yaml
kafka.kafka.strimzi.io/ping-kafka-cluster created
kafkanodepool.kafka.strimzi.io/ping-kafka-cluster-pool created
```

```bash
k get pods --namespace kafka-system
NAME                                        READY   STATUS    RESTARTS   AGE
strimzi-cluster-operator-6cf9cbf68d-hbqmf   1/1     Running   0          3m11s
```

```bash
kubectl get kafkanodepool -n kafka-system
NAME                      DESIRED REPLICAS   ROLES   NODEIDS
ping-kafka-cluster-pool   3
kubectl describe kafkanodepool ping-kafka-cluster-pool -n kafka-system
Name:         ping-kafka-cluster-pool
Namespace:    kafka-system
Labels:       strimzi.io/cluster=ping-kafka-cluster
Annotations:  <none>
API Version:  kafka.strimzi.io/v1beta2
Kind:         KafkaNodePool
Metadata:
  Creation Timestamp:  2024-10-26T18:56:24Z
  Generation:          1
  Resource Version:    294246
  UID:                 c7a67f57-1f70-4f7f-bfa1-795513478550
Spec:
  Replicas:  3
  Roles:
    broker
    controller
  Storage:
    Type:  jbod
    Volumes:
      Delete Claim:  false
      Id:            0
      Size:          1Gi
      Type:          persistent-claim
Events:              <none>
```

```bash
kubectl get kafka -n kafka-system
NAME                 DESIRED KAFKA REPLICAS   DESIRED ZK REPLICAS   READY   METADATA STATE   WARNINGS
ping-kafka-cluster
kubectl describe kafka ping-kafka-cluster -n kafka-system
Name:         ping-kafka-cluster
Namespace:    kafka-system
Labels:       skaffold.dev/run-id=43459e34-5c0f-4c03-92e4-1209c9a30cb0
Annotations:  strimzi.io/kraft: enabled
              strimzi.io/node-pools: enabled
API Version:  kafka.strimzi.io/v1beta2
Kind:         Kafka
Metadata:
  Creation Timestamp:  2024-10-26T18:56:24Z
  Generation:          1
  Resource Version:    294268
  UID:                 7ce6bbbf-5d8b-4725-8f85-850fe62ab5eb
Spec:
  Kafka:
    Config:
      default.replication.factor:                3
      inter.broker.protocol.version:             3.6
      metadata.version:                          3.6-IV2
      min.insync.replicas:                       2
      offsets.topic.replication.factor:          3
      transaction.state.log.min.isr:             2
      transaction.state.log.replication.factor:  3
    Listeners:
      Name:   plain
      Port:   9092
      Tls:    false
      Type:   internal
      Name:   external
      Port:   9093
      Tls:    false
      Type:   nodeport
    Version:  3.6.0
Status:
  Conditions:
    Last Transition Time:  2024-10-26T18:56:26.597014942Z
    Message:               Unsupported Kafka.spec.kafka.version: 3.6.0. Supported versions are: [3.7.0, 3.7.1, 3.8.0]
    Reason:                UnsupportedKafkaVersionException
    Status:                True
    Type:                  NotReady
  Observed Generation:     1
Events:                    <none>
kubectl get events -n kafka-system
LAST SEEN   TYPE     REASON              OBJECT                                           MESSAGE
8m19s       Normal   Scheduled           pod/strimzi-cluster-operator-6cf9cbf68d-hbqmf    Successfully assigned kafka-system/strimzi-cluster-operator-6cf9cbf68d-hbqmf to minikube
8m18s       Normal   Pulled              pod/strimzi-cluster-operator-6cf9cbf68d-hbqmf    Container image "quay.io/strimzi/operator:0.43.0" already present on machine
8m18s       Normal   Created             pod/strimzi-cluster-operator-6cf9cbf68d-hbqmf    Created container strimzi-cluster-operator
8m18s       Normal   Started             pod/strimzi-cluster-operator-6cf9cbf68d-hbqmf    Started container strimzi-cluster-operator
8m19s       Normal   SuccessfulCreate    replicaset/strimzi-cluster-operator-6cf9cbf68d   Created pod: strimzi-cluster-operator-6cf9cbf68d-hbqmf
63m         Normal   Scheduled           pod/strimzi-cluster-operator-cf87845f5-5p6zk     Successfully assigned kafka-system/strimzi-cluster-operator-cf87845f5-5p6zk to minikube
63m         Normal   Pulling             pod/strimzi-cluster-operator-cf87845f5-5p6zk     Pulling image "quay.io/strimzi/operator:0.43.0"
63m         Normal   Pulled              pod/strimzi-cluster-operator-cf87845f5-5p6zk     Successfully pulled image "quay.io/strimzi/operator:0.43.0" in 5.994s (5.994s including waiting)
63m         Normal   Created             pod/strimzi-cluster-operator-cf87845f5-5p6zk     Created container strimzi-cluster-operator
63m         Normal   Started             pod/strimzi-cluster-operator-cf87845f5-5p6zk     Started container strimzi-cluster-operator
8m47s       Normal   Killing             pod/strimzi-cluster-operator-cf87845f5-5p6zk     Stopping container strimzi-cluster-operator
63m         Normal   SuccessfulCreate    replicaset/strimzi-cluster-operator-cf87845f5    Created pod: strimzi-cluster-operator-cf87845f5-5p6zk
63m         Normal   ScalingReplicaSet   deployment/strimzi-cluster-operator              Scaled up replica set strimzi-cluster-operator-cf87845f5 to 1
8m19s       Normal   ScalingReplicaSet   deployment/strimzi-cluster-operator              Scaled up replica set strimzi-cluster-operator-6cf9cbf68d to 1
```

I see: Unsupported Kafka.spec.kafka.version: 3.6.0. Supported versions are: [3.7.0, 3.7.1, 3.8.0]

```bash
Status:
  Conditions:
    Last Transition Time:  2024-10-26T18:56:26.597014942Z
    Message:               Unsupported Kafka.spec.kafka.version: 3.6.0. Supported versions are: [3.7.0, 3.7.1, 3.8.0]
    Reason:                UnsupportedKafkaVersionException
    Status:                True
    Type:                  NotReady
```

Key Points:

- **Message**: The message explicitly states that the Kafka version 3.6.0 is unsupported. It also lists the supported versions: 3.7.0, 3.7.1, and 3.8.0.
- **Reason**: The reason for the issue is given as `UnsupportedKafkaVersionException`, which further confirms that the version is not supported.
- **Type**: The type is `NotReady`, indicating that the Kafka cluster is not in a ready state due to this version issue.

## Phew, it's working now that we upgraded to 3.7.0

```bash
kubectl get pods -n kafka-system
NAME                                           READY   STATUS    RESTARTS   AGE
ping-kafka-cluster-ping-kafka-cluster-pool-0   1/1     Running   0          56s
ping-kafka-cluster-ping-kafka-cluster-pool-1   1/1     Running   0          56s
ping-kafka-cluster-ping-kafka-cluster-pool-2   1/1     Running   0          56s
strimzi-cluster-operator-6cf9cbf68d-hbqmf      1/1     Running   0          12m
kubectl describe kafka ping-kafka-cluster -n kafka-system
Name:         ping-kafka-cluster
Namespace:    kafka-system
Labels:       skaffold.dev/run-id=a67a30e4-2183-4c77-b502-5efc99e008ad
Annotations:  strimzi.io/kraft: enabled
              strimzi.io/node-pools: enabled
API Version:  kafka.strimzi.io/v1beta2
Kind:         Kafka
Metadata:
  Creation Timestamp:  2024-10-26T19:06:16Z
  Generation:          1
  Resource Version:    295853
  UID:                 de7f66fa-e29b-43bb-8fd6-57ff8706c528
Spec:
  Kafka:
    Config:
      default.replication.factor:                3
      inter.broker.protocol.version:             3.7
      metadata.version:                          3.7
      min.insync.replicas:                       2
      offsets.topic.replication.factor:          3
      transaction.state.log.min.isr:             2
      transaction.state.log.replication.factor:  3
    Listeners:
      Name:   plain
      Port:   9092
      Tls:    false
      Type:   internal
      Name:   external
      Port:   9093
      Tls:    false
      Type:   nodeport
    Version:  3.7.0
Status:
  Cluster Id:  6lu7LEq_R529-X6H8CAgJQ
  Conditions:
    Last Transition Time:  2024-10-26T19:06:18.876895033Z
    Message:               inter.broker.protocol.version is not used in KRaft-based Kafka clusters and should be removed from the Kafka custom resource.
    Reason:                KafkaInterBrokerProtocolVersionInKRaft
    Status:                True
    Type:                  Warning
    Last Transition Time:  2024-10-26T19:07:02.168044248Z
    Status:                True
    Type:                  Ready
  Kafka Metadata State:    KRaft
  Kafka Metadata Version:  3.7-IV4
  Kafka Node Pools:
    Name:         ping-kafka-cluster-pool
  Kafka Version:  3.7.0
  Listeners:
    Addresses:
      Host:             ping-kafka-cluster-kafka-bootstrap.kafka-system.svc
      Port:             9092
    Bootstrap Servers:  ping-kafka-cluster-kafka-bootstrap.kafka-system.svc:9092
    Name:               plain
    Addresses:
      Host:                          192.168.49.2
      Port:                          30109
    Bootstrap Servers:               192.168.49.2:30109
    Name:                            external
  Observed Generation:               1
  Operator Last Successful Version:  0.43.0
  Registered Node Ids:
    0
    1
    2
Events:  <none>
```

## Using k9s to check the status of the Kafka cluster

Install / open k9s:

```bash
brew install k9s
k9s
```

Switch namespaces to `kafka-system` and check the status of the Kafka cluster:

```bash
:ns
```

```bash
/kafka-system
```

Then open the instance which you want to check.

You can also just check *all namespaces* like this:

```bash
:ns
```

```bash
all+(*)
```
