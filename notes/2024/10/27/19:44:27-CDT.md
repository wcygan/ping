# Pivoting on the Flink Sink

I originally planned to use ScyllaDB as a sink for the data that Flink processes, but honestly it has been too difficult to get the ScyllaDB Operators running on k8s.

To that end, I'm going to try something new.

I'll either use `redis` or `dragonfly` as a sink for the data that Flink processes. Hopefully, this will be easier to set up and manage.

## Dragonfly

```bash
curl https://raw.githubusercontent.com/dragonflydb/dragonfly-operator/main/manifests/dragonfly-operator.yaml > dragonfly/dragonfly-operator.yaml
```

```bash
kubectl apply -f dragonfly/dragonfly-operator.yaml
```

```bash
curl https://raw.githubusercontent.com/dragonflydb/dragonfly-operator/main/config/samples/v1alpha1_dragonfly.yaml > dragonfly/dragonfly.yaml
```

```bash
kubectl apply -f dragonfly/dragonfly.yaml
```

## Connecting to an instance

```bash
kubectl run -it --rm --restart=Never redis-cli --image=redis:7.0.10 -- redis-cli -h dragonfly-sample.default
```

```bash
dragonfly-sample.default:6379> get 1
(nil)
dragonfly-sample.default:6379> set 1 2
OK
dragonfly-sample.default:6379> get 1
"2"
```

## Scale replicas:

```bash
kubectl patch dragonfly dragonfly-sample --type merge -p '{"spec":{"replicas":5}}'
```

```bash
kubectl patch dragonfly dragonfly-sample --type merge -p '{"spec":{"replicas":1}}'
```

## Check who is `master`

```bash
kubectl get pods -l role=master
```

## BufferingSink and Jedis

There doesn't currently seem to be a Flink-Redis Sink that's widely available, so we can create something that will do the job.

The idea is to create a `BufferingSink` that will buffer the data in memory and then flush it to Redis when the checkpoint is completed.

https://nightlies.apache.org/flink/flink-docs-release-1.13/docs/dev/datastream/fault-tolerance/state/#checkpointedfunction
https://github.com/redis/jedis

## Building flink with Docker

```bash
docker build -t ping-processor --platform linux/arm64 .
```

## Find all keys in Redis

First, create a pod to connect to the Redis instance:

```bash
kubectl run -it --rm --restart=Never redis-cli --image=redis:7.0.10 -- redis-cli -h ping-cache.default
kubectl exec -it redis-cli -- redis-cli -h ping-cache.default
```

Then execute commands:

```bash
KEYS '*'
```

## Last Steps..

- Update the Server code to fetch from Cache instead of DB
- Update Readme
- Update Ping V2 Readme