# Helm Installation of Scylla

Currently, your Skaffold configuration is attempting this (but it doesn't work):

```bash
helm --kube-context minikube install scylla --version 1.14.0 scylla --post-renderer /opt/homebrew/bin/skaffold --namespace scylla --repo https://scylla-operator-charts.storage.googleapis.com/stable --create-namespace -f /Users/wcygan/Development/ping/scylla/scylla-values.yaml --wait
```

These do work:

```bash
helm uninstall scylla scylla/scylla
release "scylla" uninstalled
Error: uninstall: Release name is invalid: scylla/scylla

helm install scylla scylla/scylla
NAME: scylla
LAST DEPLOYED: Sun Oct 27 17:22:54 2024
NAMESPACE: default
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
The Scylla Cluster has been deployed. Check its status by running:

  kubectl -n default get pods -l "app.kubernetes.io/name=scylla"

Visit https://github.com/scylladb/scylla-operator for tutorials on how to
maintain Scylla clusters using the Scylla Operator and set up monitoring.

helm search repo scylla
NAME                  	CHART VERSION	APP VERSION	DESCRIPTION
scylla/scylla         	v1.14.0      	1.14.0     	Scylla is a close-to-the-hardware rewrite of Ca...
scylla/scylla-manager 	v1.14.0      	1.14.0     	Scylla Manager automates database operations.
scylla/scylla-operator	v1.14.0      	1.14.0     	Scylla Operator is a Kubernetes Operator for ma...
```

The exact error is:

```bash
helm --kube-context minikube install scylla --version 1.14.0 scylla --post-renderer /opt/homebrew/bin/skaffold --namespace scylla --repo https://scylla-operator-charts.storage.googleapis.com/stable --create-namespace -f /Users/wcygan/Development/ping/scylla/scylla-values.yaml --wait
Error: INSTALLATION FAILED: Chart.yaml file is missing
```

This is another way to reproduce it:

```bash
helm install scylla scylla/scylla --version 1.14.0 --repo https://scylla-operator-charts.storage.googleapis.com/stable
Error: INSTALLATION FAILED: chart "scylla/scylla" version "1.14.0" not found in https://scylla-operator-charts.storage.googleapis.com/stable repository
```

## Pod is restarting

wcygan@foobar ping %  kubectl get pvc -n scylla-manager 
NAME                                            STATUS    VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS         VOLUMEATTRIBUTESCLASS   AGE
data-scylla-manager-manager-dc-manager-rack-0   Pending                                      scylladb-local-xfs   <unset>                 127m
wcygan@foobar ping %  kubectl get storageclass    
NAME                 PROVISIONER                RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE
standard (default)   k8s.io/minikube-hostpath   Delete          Immediate           false                  18h


kubectl get events -n scylla-manager --sort-by='.lastTimestamp'
f78113d3ffaac306edf6d3c4346e1fa0bf" already present on machine
55s         Warning   Unhealthy                    pod/scylla-manager-67b6c559f8-v2428                                   Readiness probe failed: Get "http://10.244.0.178:5080/api/v1/clusters": dial tcp 10.244.0.178:5080: connect: connection refused
2s          Warning   ProvisioningFailed           persistentvolumeclaim/data-scylla-manager-manager-dc-manager-rack-0   storageclass.storage.k8s.io "scylladb-local-xfs" not found

 kubectl describe pod scylla-manager-manager-dc-manager-rack-0 -n scylla-manager                                                                                                         
Name:             scylla-manager-manager-dc-manager-rack-0
Namespace:        scylla-manager
Priority:         0
Service Account:  scylla-manager-member
Node:             <none>
Labels:           app=scylla
                  app.kubernetes.io/managed-by=scylla-operator
                  app.kubernetes.io/name=scylla
                  apps.kubernetes.io/pod-index=0
                  controller-revision-hash=scylla-manager-manager-dc-manager-rack-59b964dfbd
                  scylla/cluster=scylla-manager
                  scylla/datacenter=manager-dc
                  scylla/rack=manager-rack
                  scylla/rack-ordinal=0
                  scylla/scylla-version=6.1.1
                  statefulset.kubernetes.io/pod-name=scylla-manager-manager-dc-manager-rack-0
Annotations:      meta.helm.sh/release-name: scylla-manager
                  meta.helm.sh/release-namespace: scylla-manager
                  prometheus.io/port: 9180
                  prometheus.io/scrape: true
                  scylla-operator.scylladb.com/inputs-hash: MXHlYjcFSZGBYA1nyaAMDx4/BxQC+CNkCfZm66EWsLpGcoBb/aLgNhHHQzvt7EXKpzl2We5+VkkXAr+TO6e8VA==
Status:           Pending
IP:               
IPs:              <none>
Controlled By:    StatefulSet/scylla-manager-manager-dc-manager-rack
Init Containers:
  sidecar-injection:
    Image:      scylladb/scylla-operator:1.14.0
    Port:       <none>
    Host Port:  <none>
    Command:
      /bin/sh
      -c
      cp -a /usr/bin/scylla-operator /mnt/shared
    Limits:
      cpu:     10m
      memory:  50Mi
    Requests:
      cpu:        10m
      memory:     50Mi
    Environment:  <none>
    Mounts:
      /mnt/shared from shared (rw)
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-56hvj (ro)
Containers:
  scylla:
    Image:       scylladb/scylla:6.1.1
    Ports:       7000/TCP, 7001/TCP, 9042/TCP, 9142/TCP, 7199/TCP, 9180/TCP, 9100/TCP, 9160/TCP
    Host Ports:  0/TCP, 0/TCP, 0/TCP, 0/TCP, 0/TCP, 0/TCP, 0/TCP, 0/TCP
    Command:
      /usr/bin/bash
      -euEo
      pipefail
      -O
      inherit_errexit
      -c
      printf 'INFO %s ignition - Waiting for /mnt/shared/ignition.done\n' "$( date '+%Y-%m-%d %H:%M:%S,%3N' )" > /dev/stderr
      until [[ -f "/mnt/shared/ignition.done" ]]; do
        sleep 1;
      done
      printf 'INFO %s ignition - Ignited. Starting ScyllaDB...\n' "$( date '+%Y-%m-%d %H:%M:%S,%3N' )" > /dev/stderr
      
      # TODO: This is where we should start ScyllaDB directly after the sidecar split #1942 
      exec /mnt/shared/scylla-operator sidecar \
      --feature-gates=AllAlpha=false,AllBeta=false,AutomaticTLSCertificates=true \
      --nodes-broadcast-address-type=ServiceClusterIP \
      --clients-broadcast-address-type=ServiceClusterIP \
      --service-name=$(SERVICE_NAME) \
      --cpu-count=$(CPU_COUNT) \
      --loglevel=2 \
    Limits:
      cpu:     1
      memory:  200Mi
    Requests:
      cpu:      1
      memory:   200Mi
    Liveness:   http-get http://:8080/healthz delay=0s timeout=10s period=10s #success=1 #failure=12
    Readiness:  http-get http://:8080/readyz delay=0s timeout=30s period=10s #success=1 #failure=1
    Startup:    http-get http://:8080/healthz delay=0s timeout=30s period=10s #success=1 #failure=40
    Environment:
      SERVICE_NAME:  scylla-manager-manager-dc-manager-rack-0 (v1:metadata.name)
      CPU_COUNT:     1 (limits.cpu)
    Mounts:
      /mnt/scylla-client-config from scylla-client-config-volume (ro)
      /mnt/scylla-config from scylla-config-volume (ro)
      /mnt/shared from shared (ro)
      /var/lib/scylla from data (rw)
      /var/run/configmaps/scylla-operator.scylladb.com/scylladb/managed-config from scylladb-managed-config (ro)
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-56hvj (ro)
      /var/run/secrets/scylla-operator.scylladb.com/scylladb/client-ca from scylladb-client-ca (ro)
      /var/run/secrets/scylla-operator.scylladb.com/scylladb/serving-certs from scylladb-serving-certs (ro)
      /var/run/secrets/scylla-operator.scylladb.com/scylladb/user-admin from scylladb-user-admin (ro)
  scylladb-api-status-probe:
    Image:      scylladb/scylla-operator:1.14.0
    Port:       <none>
    Host Port:  <none>
    Command:
      /usr/bin/scylla-operator
      serve-probes
      scylladb-api-status
      --port=8080
      --service-name=$(SERVICE_NAME)
      --loglevel=2
    Limits:
      cpu:     10m
      memory:  40Mi
    Requests:
      cpu:      10m
      memory:   40Mi
    Readiness:  tcp-socket :8080 delay=0s timeout=30s period=5s #success=1 #failure=1
    Environment:
      SERVICE_NAME:  scylla-manager-manager-dc-manager-rack-0 (v1:metadata.name)
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-56hvj (ro)
  scylladb-ignition:
    Image:      scylladb/scylla-operator:1.14.0
    Port:       <none>
    Host Port:  <none>
    Command:
      /usr/bin/scylla-operator
      run-ignition
      --service-name=$(SERVICE_NAME)
      --nodes-broadcast-address-type=ServiceClusterIP
      --clients-broadcast-address-type=ServiceClusterIP
      --loglevel=2
    Limits:
      cpu:     10m
      memory:  40Mi
    Requests:
      cpu:      10m
      memory:   40Mi
    Readiness:  http-get http://:42081/readyz delay=0s timeout=30s period=5s #success=1 #failure=1
    Environment:
      SERVICE_NAME:  scylla-manager-manager-dc-manager-rack-0 (v1:metadata.name)
    Mounts:
      /mnt/shared from shared (rw)
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-56hvj (ro)
  scylla-manager-agent:
    Image:      scylladb/scylla-manager-agent:3.3.0@sha256:dc2684f51e961d88da5a8eac2d9f165cb7a960cbf91f67f49332e7224317c96b
    Port:       10001/TCP
    Host Port:  0/TCP
    Command:
      /usr/bin/bash
      -euEo
      pipefail
      -O
      inherit_errexit
      -c
      printf '{"L":"INFO","T":"%s","M":"Waiting for /mnt/shared/ignition.done"}\n' "$( date -u '+%Y-%m-%dT%H:%M:%S,%3NZ' )" > /dev/stderr
      until [[ -f "/mnt/shared/ignition.done" ]]; do
        sleep 1;
      done
      printf '{"L":"INFO","T":"%s","M":"Ignited. Starting ScyllaDB Manager Agent"}\n' "$( date -u '+%Y-%m-%dT%H:%M:%S,%3NZ' )" > /dev/stderr
      
      scylla-manager-agent \
      -c "/etc/scylla-manager-agent/scylla-manager-agent.yaml" \
      -c "/mnt/scylla-agent-config/scylla-manager-agent.yaml" \
      -c "/mnt/scylla-agent-config/auth-token.yaml"
    Requests:
      cpu:        50m
      memory:     10M
    Readiness:    tcp-socket :10001 delay=0s timeout=1s period=10s #success=1 #failure=3
    Environment:  <none>
    Mounts:
      /mnt/scylla-agent-config/auth-token.yaml from scylla-agent-auth-token-volume (ro,path="auth-token.yaml")
      /mnt/scylla-agent-config/scylla-manager-agent.yaml from scylla-agent-config-volume (ro,path="scylla-manager-agent.yaml")
      /mnt/shared from shared (ro)
      /var/lib/scylla from data (rw)
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-56hvj (ro)
Conditions:
  Type           Status
  PodScheduled   False 
Volumes:
  data:
    Type:       PersistentVolumeClaim (a reference to a PersistentVolumeClaim in the same namespace)
    ClaimName:  data-scylla-manager-manager-dc-manager-rack-0
    ReadOnly:   false
  shared:
    Type:       EmptyDir (a temporary directory that shares a pod's lifetime)
    Medium:     
    SizeLimit:  <unset>
  scylla-config-volume:
    Type:      ConfigMap (a volume populated by a ConfigMap)
    Name:      scylla-config
    Optional:  true
  scylladb-managed-config:
    Type:      ConfigMap (a volume populated by a ConfigMap)
    Name:      scylla-manager-managed-config
    Optional:  false
  scylla-agent-config-volume:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  scylla-agent-config-secret
    Optional:    true
  scylla-client-config-volume:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  scylla-client-config-secret
    Optional:    true
  scylla-agent-auth-token-volume:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  scylla-manager-auth-token
    Optional:    false
  scylladb-serving-certs:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  scylla-manager-local-serving-certs
    Optional:    false
  scylladb-client-ca:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  scylla-manager-local-client-ca
    Optional:    false
  scylladb-user-admin:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  scylla-manager-local-user-admin
    Optional:    false
  kube-api-access-56hvj:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   Burstable
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type     Reason            Age    From               Message
  ----     ------            ----   ----               -------
  Warning  FailedScheduling  6m44s  default-scheduler  0/1 nodes are available: pod has unbound immediate PersistentVolumeClaims. preemption: 0/1 nodes are available: 1 Preemption is not helpful for scheduling.
  Warning  FailedScheduling  104s   default-scheduler  0/1 nodes are available: pod has unbound immediate PersistentVolumeClaims. preemption: 0/1 nodes are available: 1 Preemption is not helpful for scheduling.
